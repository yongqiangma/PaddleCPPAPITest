##### Storage.h å¤´æ–‡ä»¶ API å…¼å®¹æƒ…å†µ


##### Storage.h å¤´æ–‡ä»¶ API å…¼å®¹æ€§

âœ… è¡¨ç¤ºå·²ç»æ”¯æŒ
ğŸš§ è¡¨ç¤ºæ­£åœ¨æ”¯æŒ
âŒ è¡¨ç¤ºä¸å‡†å¤‡æ”¯æŒ
ğŸ”§ è¡¨ç¤ºéƒ¨åˆ†æ”¯æŒï¼ˆæœ‰åŠŸèƒ½é™åˆ¶ï¼‰

**æŒ‰ç…§åŠŸèƒ½åˆ†ç±»æ’åº**

---

### æ ‡ç­¾ç±»å‹

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `Storage::use_byte_size_t`   | âœ…               | âœ…          |   P0  | æ„é€ å‡½æ•°æ ‡ç­¾ |
| `Storage::unsafe_borrow_t`   | âœ…               | âœ…          |   P2  | å€Ÿç”¨æ„é€ æ ‡ç­¾ |

---

### æ„é€ ä¸èµ‹å€¼

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `Storage()`                  | âœ…               | âœ…          |   P0  | é»˜è®¤æ„é€ å‡½æ•° |
| `Storage(const Storage&)`    | âœ…               | âœ…          |   P0  | æ‹·è´æ„é€ å‡½æ•° |
| `Storage(Storage&&)`         | âœ…               | âœ…          |   P0  | ç§»åŠ¨æ„é€ å‡½æ•° |
| `operator=(const Storage&)`  | âœ…               | âœ…          |   P0  | æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ |
| `operator=(Storage&&)`       | âœ…               | âœ…          |   P0  | ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ |
| `Storage(intrusive_ptr<StorageImpl>)` | ğŸ”§      | ğŸ”§          |   P1  | ä½¿ç”¨ shared_ptr<Allocation> |
| `Storage(use_byte_size_t, SymInt, Allocator*, bool)` | ğŸ”§ | ğŸ”§ |   P1  | ä¸æ”¯æŒ SymInt |
| `Storage(use_byte_size_t, size_t, DataPtr, Allocator*, bool)` | âœ… | âœ… |   P1  | é¢„åˆ†é…å†…å­˜æ„é€  |

---

### çŠ¶æ€æŸ¥è¯¢ API

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `operator bool()`            | âœ…               | âœ…          |   P0  | æœ‰æ•ˆæ€§æ£€æŸ¥ |
| `nbytes()`                   | âœ…               | âœ…          |   P0  | è·å–å­—èŠ‚æ•° |
| `sym_nbytes()`               | - [ ]            | - [ ]       |   P3  | ç¬¦å·åŒ–å­—èŠ‚æ•° |
| `resizable()`                | âœ…               | âœ…          |   P1  | æ˜¯å¦å¯è°ƒæ•´å¤§å° |
| `unique()`                   | âœ…               | âœ…          |   P1  | æ˜¯å¦å”¯ä¸€æŒæœ‰ |
| `use_count()`                | âœ…               | âœ…          |   P1  | å¼•ç”¨è®¡æ•° |

---

### æ•°æ®è®¿é—® API

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `data()`                     | âœ…               | âœ…          |   P0  | è·å– const æ•°æ®æŒ‡é’ˆ |
| `mutable_data()`             | âœ…               | âœ…          |   P0  | è·å–å¯å˜æ•°æ®æŒ‡é’ˆ |
| `data_ptr()`                 | âœ…               | âœ…          |   P0  | è·å– DataPtr |
| `mutable_data_ptr()`         | âœ…               | âœ…          |   P0  | è·å–å¯å˜ DataPtr |

---

### è®¾å¤‡ç›¸å…³ API

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `device()`                   | âœ…               | âœ…          |   P0  | è·å–è®¾å¤‡ |
| `device_type()`              | âœ…               | âœ…          |   P0  | è·å–è®¾å¤‡ç±»å‹ |
| `allocator()`                | âœ…               | âœ…          |   P1  | è·å–åˆ†é…å™¨ |

---

### æ•°æ®ä¿®æ”¹ API

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `set_nbytes(size_t)`         | âœ…               | âœ…          |   P1  | è®¾ç½®å­—èŠ‚æ•° |
| `set_nbytes(SymInt)`         | - [ ]            | - [ ]       |   P3  | ç¬¦å·åŒ–è®¾ç½®å­—èŠ‚æ•° |
| `set_data_ptr(DataPtr&&)`    | âœ…               | âœ…          |   P1  | è®¾ç½®æ•°æ®æŒ‡é’ˆï¼ˆäº¤æ¢ï¼‰ |
| `set_data_ptr_noswap(DataPtr&&)` | âœ…           | âœ…          |   P1  | è®¾ç½®æ•°æ®æŒ‡é’ˆï¼ˆä¸äº¤æ¢ï¼‰ |

---

### åˆ«åæ£€æµ‹ API

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `is_alias_of(Storage)`       | âœ…               | âœ…          |   P1  | æ£€æŸ¥æ˜¯å¦ä¸ºåˆ«å |
| `isSharedStorageAlias()`     | âœ…               | âœ…          |   P1  | å…¨å±€åˆ«åæ£€æµ‹å‡½æ•° |

---

### å†…éƒ¨è®¿é—® API

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `unsafeGetStorageImpl()`     | ğŸ”§               | ğŸ”§          |   P2  | è¿”å› phi::Allocation* |
| `unsafeReleaseStorageImpl()` | ğŸ”§               | ğŸ”§          |   P2  | è¿”å› phi::Allocation* |
| `getWeakStorageImpl()`       | - [ ]            | - [ ]       |   P3  | å¼±å¼•ç”¨ |

---

### é™æ€å·¥å‚æ–¹æ³•

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `create_legacy(Device)`      | - [ ]            | - [ ]       |   P3  | åˆ›å»ºé—ç•™å­˜å‚¨ |
| `reset_legacy()`             | - [ ]            | - [ ]       |   P3  | é‡ç½®é—ç•™å­˜å‚¨ |

---

### å¤–éƒ¨æŒ‡é’ˆå…±äº« API

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `UniqueStorageShareExternalPointer(void*, size_t, DeleterFnPtr)` | - [ ] | - [ ] | P2 |  |
| `UniqueStorageShareExternalPointer(DataPtr&&, size_t)` | - [ ] | - [ ] | P2 |  |

---

### MaybeOwnedTraits ç‰¹åŒ–

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `createBorrow()`             | âœ…               | âœ…          |   P2  | åˆ›å»ºå€Ÿç”¨ |
| `assignBorrow()`             | âœ…               | âœ…          |   P2  | èµ‹å€¼å€Ÿç”¨ |
| `destroyBorrow()`            | âœ…               | âœ…          |   P2  | é”€æ¯å€Ÿç”¨ |
| `referenceFromBorrow()`      | âœ…               | âœ…          |   P2  | ä»å€Ÿç”¨è·å–å¼•ç”¨ |
| `pointerFromBorrow()`        | âœ…               | âœ…          |   P2  | ä»å€Ÿç”¨è·å–æŒ‡é’ˆ |
| `debugBorrowIsValid()`       | âœ…               | âœ…          |   P3  | è°ƒè¯•æ£€æŸ¥ |

---

### ExclusivelyOwnedTraits ç‰¹åŒ–

| torch API                    | paddle API å…¼å®¹æ€§ | æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ | ä¼˜å…ˆçº§ | å¤‡æ³¨ |
|------------------------------|------------------|------------|-------|------|
| `nullRepr()`                 | âœ…               | âœ…          |   P2  | ç©ºè¡¨ç¤º |
| `createInPlace()`            | âœ…               | âœ…          |   P2  | å°±åœ°åˆ›å»º |
| `moveToRepr()`               | âœ…               | âœ…          |   P2  | ç§»åŠ¨åˆ°è¡¨ç¤º |
| `take()`                     | âœ…               | âœ…          |   P2  | å–èµ°æ‰€æœ‰æƒ |
| `getImpl()`                  | âœ…               | âœ…          |   P2  | è·å–å®ç°æŒ‡é’ˆ |

---

### Paddle å…¼å®¹å±‚ç‰¹æœ‰ API

| API                          | è¯´æ˜ |
|------------------------------|------|
| `valid()`                    | æ£€æŸ¥å­˜å‚¨æ˜¯å¦æœ‰æ•ˆï¼ˆæœ‰åˆ†é…ï¼‰ |
| `allocation()`               | è·å–åº•å±‚ phi::Allocation |
| `unsafeGetAllocation()`      | ä¸å®‰å…¨è·å– phi::Allocation æŒ‡é’ˆ |
| `unsafeReleaseAllocation()`  | ä¸å®‰å…¨é‡Šæ”¾ phi::Allocation |

---

### å…¼å®¹æ€§ç»Ÿè®¡

| çŠ¶æ€ | æ•°é‡ |
|------|------|
| âœ… å·²å®Œå…¨æ”¯æŒ | 35 |
| ğŸš§ æ­£åœ¨æ”¯æŒ | 0 |
| ğŸ”§ éƒ¨åˆ†æ”¯æŒ | 4 |
| - [ ] æœªå®ç° | 8 |

---

### å¤‡æ³¨

1. **ä¼˜å…ˆçº§è¯´æ˜**ï¼š
   - P0: æ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»æ”¯æŒ
   - P1: å¸¸ç”¨åŠŸèƒ½ï¼Œé«˜ä¼˜å…ˆçº§
   - P2: è¿›é˜¶åŠŸèƒ½ï¼Œä¸­ä¼˜å…ˆçº§
   - P3: è¾¹ç¼˜åŠŸèƒ½ï¼Œä½ä¼˜å…ˆçº§

2. **å®ç°è¯´æ˜**ï¼š
   - Paddle å…¼å®¹å±‚çš„ `Storage` åŸºäº `phi::Allocation` å®ç°ï¼Œè€Œé `StorageImpl`
   - åˆ†é…å™¨ä½¿ç”¨ `phi::Allocator*` è€Œé `c10::Allocator*`
   - è®¾å¤‡ç±»å‹ä½¿ç”¨ `phi::Place` å’Œ `phi::AllocationType`

3. **éƒ¨åˆ†æ”¯æŒè¯´æ˜**ï¼š
   - `Storage(intrusive_ptr<StorageImpl>)`: ä½¿ç”¨ `shared_ptr<phi::Allocation>` æ›¿ä»£
   - `Storage(use_byte_size_t, SymInt, ...)`: ä¸æ”¯æŒç¬¦å·åŒ–æ•´æ•°ï¼Œä»…æ”¯æŒ `size_t`
   - `unsafeGetStorageImpl()` / `unsafeReleaseStorageImpl()`: è¿”å› `phi::Allocation*` è€Œé `StorageImpl*`

4. **ç¬¦å·åŒ– API** (`sym_*`): ç”¨äºåŠ¨æ€å½¢çŠ¶åœºæ™¯ï¼Œç›®å‰å‡æœªæ”¯æŒ
